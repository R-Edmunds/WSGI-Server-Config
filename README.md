# Linux Server Configuration - Robin Edmunds

## Summary
I used a digitalocean.com VPS for this project. I am serving my site using https as facebook's oauth2 API no longer works on plain http.

- SSH:  udacity.robin.bz:2200
- Address:  https://udacity.robin.bz
- GitHub:  https://github.com/R-Edmunds/Music-Collector

## Steps
### Account creation
Generated 2x SSH key pairs using PuTTYgen. DigitalOcean automatically placed my key into __/home/robin/.ssh/authorized_keys__ during setup. I did this manually for the grader account.

I then ran the following command to give the grader account sudo access: -
> sudo usermod -G sudo grader

### Update packages
- sudo apt update && sudo apt upgrade -y

### sshd
Edited the following lines in __/etc/ssh/sshd_config__
- Port 2200
- PermitRootLogin no
- PasswordAuthentication no

Restarted process with __sudo systemctl restart sshd__

### Firewall
- sudo ufw enable
- sudo ufw allow 2200/tcp
- sudo ufw allow 80/tcp
- sudo ufw allow 123/tcp
- sudo ufw allow 443/tcp
- sudo ufw default deny incoming
- sudo ufw default allow outgoing

Used the following to check rules: -
- sudo ufw status verbose

## Package installs (apt)
I used the following commands to install packages using the apt package manager on Ubuntu 18.04: -
- sudo apt install apache2
- sudo apt install libapache2-mod-wsgi-py3
- sudo apt install postgresql
- sudo apt install python3-pip
- sudo apt install certbot
- sudo apt install python3-certbot-apache

I used the following command on both apache2 and postgresql to ensure that they start automatically on system boot: -
- sudo systemctl enable apache2
- sudo systemctl enable postgresql

## Package installs (pip3)
Used __sudo pip3 install pkg__ on the following packages: -
- Flask (1.0.2)
- google-auth (1.6.2)
- psycopg2 (2.7.6.1)
- psycopg2-binary (2.7.6.1)
- pyOpenSSL (17.5.0)
- requests (2.18.4)
- simplejson (3.16.0)
- SQLAlchemy (1.2.15)
- Werkzeug (0.14.1)

## apache/wsgi configuration
I navigated to my home directory and made a git pull request on my apps git repo. I then symlinked this directory to __"/var/www/mc"__.

I then created the file __"/var/www/mc/mc.wsgi"__: -

```python
import sys
sys.path.append('/var/www/mc')
from mcviews import app as application
```


I copied the default apache site config file to __"/etc/apache2/sites-available/002-wsgi-mc.conf"__ and edited it with vi. I then deleted the default site config from __"/etc/apache2/sites-enabled"__ and symlinked my config to this directory. The Rewrite lines at the bottom are generated by "certbot" to forward http requests to https. Whenever I made changes I used __sudo systemctl restart apache2__ to make them active.

```apache
<VirtualHost *:80>
        # The ServerName directive sets the request scheme, hostname and port that
        # the server uses to identify itself. This is used when creating
        # redirection URLs. In the context of virtual hosts, the ServerName
        # specifies what hostname must appear in the request's Host: header to
        # match this virtual host. For the default virtual host (this file) this
        # value is not decisive as it is used as a last resort host regardless.
        # However, you must set it for any further virtual host explicitly.
        ServerName udacity.robin.bz

        ServerAdmin webmaster@localhost
        DocumentRoot /var/www/mc

        # Available loglevels: trace8, ..., trace1, debug, info, notice, warn,
        # error, crit, alert, emerg.
        # It is also possible to configure the loglevel for particular
        # modules, e.g.
        #LogLevel info ssl:warn

        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined

        # For most configuration files from conf-available/, which are
        # enabled or disabled at a global level, it is possible to
        # include a line for only one particular virtual host. For example the
        # following line enables the CGI configuration for this host only
        # after it has been globally disabled with "a2disconf".
        #Include conf-available/serve-cgi-bin.conf

        # ADDED BY ROBIN
        WSGIScriptAlias / /var/www/mc/mc.wsgi

RewriteEngine on
RewriteCond %{SERVER_NAME} =udacity.robin.bz
RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]
</VirtualHost>
```

I used the __"sudo certbot --apache"__ command to acquire a signed TLS certificate from the Let's Encrypt service and generate a TLS enabled apache site config file.


## postgresql configuration
1. sudo su - postgres
1. psql
1. CREATE ROLE mc WITH LOGIN PASSWORD 'userpassword';
1. CREATE DATABASE mc WITH OWNER mc;

## Changes to my app
I had to make the following changes to my app code for it work with postgres and wsgi.

In both mcmodels.py and mcviews.py: -
> import psycopg2

> engine = create_engine("postgresql+psycopg2://mc:DBPASSWORD@127.0.0.1:5432/mc")

In mcviews.py alone: -
> app.secret_key = "LONG-STATIC-SECRET"


## Resources used
- http://www.postgresqltutorial.com/postgresql-cheat-sheet/
- https://www.postgresql.org/docs/11/index.html
- https://www.jakowicz.com/flask-apache-wsgi/
